using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Xunit;

namespace Vereyon.Web
{
    public class MalisciousTests
    {

        /// <summary>
        /// Check if a this sample SPAM message does not lead to a stackoverflow exception.
        /// </summary>
        /// <remarks>
        /// Submitted by a user who encountered this in the wild.
        /// </remarks>
        [Fact]
        public void DivStackOverflowAttempt()
        {

            string result;
            var sanitizer = new HtmlSanitizer();
            sanitizer.Tag("div");
            sanitizer.MaxRecursionDepth = 10;

            // Sanitizing this message should throw a InvalidOperationException instead of a StackOverflowException
            var input = @"<meta http-equiv=""Content-Type"" content=""text/html; charset=utf-8""><div class=""reply-body"">    <div>    <span style=""font-family: arial, helvetica, sans-serif;""><span style=""font-size: 14px;""><span style=""color: #000000;"">Hi friend,</span></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;   </div>   </div>   <div>    <div class=""reply-body"">    &nbsp;   </div>    <div>     <div>      <div>       <div>        <div>         <div>          <div>           <div>            <div>             <div>              <div>               <div>                <div>                 <div>                  <div>                   <div>                    <div>                     <div>                      <div>                       <div>                        <div>                         <div>                          <div>                           <div>                            <div>                             <div>                              <div>                               <div>                                <div>                                 <div>                                  <div>                                   <div>                                    <div>                                     <div>                                      <div>                                       <div>                                        <div>                                         <div>                                          <div>                                           <div>                                            <div>                                             <div>                                              <div>                                               <div>                                                <div>                                                 <div>                                                  <div>                                                   <div>                                                    <div>                                                     <div>                                                      <div>                                                       <div>                                                        <div>                                                         <div>                                                          <div>                                                           <div>                                                            <div>                                                             <div>                                                              <div>                                                               <div>                                                                <div>                                                                 <div>                                                                  <div>                                                                   <div>                                                                    <div>                                                                     <div>                                                                      <div>                                                                       <div>                                                                        <div>                                                                         <div>                                                                          <div>                                                                           <div>                                                                            <div>                                                                             <div>                                                                              <div>                                                                               <div>                                                                                <div>                                                                                 <div>                                                                                  <div>                                                                                   <div>                                                                                    <div>                                                                                     <div>                                                                                      <div>                                                                                       <div>                                                                                        <div>                                                                                         <div>                                                                                          <div>                                                                                           <div>                                                                                            <div>                                                                                             <div>                                                                                              <div>                                                                                               <div>                                                                                                <div>                                                                                                 <div>                                                                                                  <div>                                                                                                   <div>                                                                                                    <div>                                                                                                     <div>                                                                                                      <div>                                                                                                       <div>                                                                                                        <div>                                                                                                         <div>                                                                                                          <div>                                                                                                           <div>                                                                                                            <div>                                                                                                             <div>                                                                                                              <div>                                                                                                               <div>                                                                                                                <div>                                                                                                                 <div>                                                                                                                  <div>                                                                                                                   <div>                                                                                                                    <div>                                                                                                                     <div>                                                                                                                      <div>                                                                                                                       <div>                                                                                                                        <div>                                                                                                                         <div>                                                                                                                          <div>                                                                                                                           <div>                                                                                                                            <div>                                                                                                                             <div>                                                                                                                              <div>                                                                                                                               <div>                                                                                                                                <div>                                                                                                                                 <div>                                                                                                                                  <div>                                                                                                                                   <div>                                                                                                                                    <div>                                                                                                                                     <div>                                                                                                                                      <div>                                                                                                                                       <div>                                                                                                                                        <div>                                                                                                                                         <div>                                                                                                                                          <div>                                                                                                                                           <div>                                                                                                                                            <div>                                                                                                                                             <div>                                                                                                                                              <div>                                                                                                                                               <div>                                                                                                                                                <div>                                                                                                                                                 <div>                                                                                                                                                  <div>                                                                                                                                                   <div>                                                                                                                                                    <div>                                                                                                                                                     <div>                                                                                                                                                      <div>                                                                                                                                                       <div>                                                                                                                                                        <div>                                                                                                                                                         <div>                                                                                                                                                          <div>                                                                                                                                                           <div>                                                                                                                                                            <div>                                                                                                                                                             <div>                                                                                                                                                              <div>                                                                                                                                                               <div>                                                                                                                                                                <div>                                                                                                                                                                 <div>                                                                                                                                                                  <div>                                                                                                                                                                   <div>                                                                                                                                                                    <div>                                                                                                                                                                     <div>                                                                                                                                                                      <div>                                                                                                                                                                       <div>                                                                                                                                                                        <div>                                                                                                                                                                         <div>                                                                                                                                                                          <div>                                                                                                                                                                           <div>                                                                                                                                                                            <div>                                                                                                                                                                             <div>                                                                                                                                                                              <div>                                                                                                                                                                               <div>                                                                                                                                                                                <div>                                                                                                                                                                                 <div>                                                                                                                                                                                  <div>                                                                                                                                                                                   <div>                                                                                                                                                                                    <div>                                                                                                                                                                                     <div>                                                                                                                                                                                      <div>                                                                                                                                                                                       <div>                                                                                                                                                                                        <div>                                                                                                                                                                                         <div>                                                                                                                                                                                          <div>                                                                                                                                                                                           <div>                                                                                                                                                                                            <div>                                                                                                                                                                                             <div>                                                                                                                                                                                              <div>                                                                                                                                                                                               <div>                                                                                                                                                                                                <div>                                                                                                                                                                                                 <div>                                                                                                                                                                                                  <div>                                                                                                                                                                                                   <div>                                                                                                                                                                                                    <div>                                                                                                                                                                                                     <div>                                                                                                                                                                                                      <div>                                                                                                                                                                                                       <div>                                                                                                                                                                                                        <div>                                                                                                                                                                                                         <div>                                                                                                                                                                                                          <div>                                                                                                                                                                                                           <div>                                                                                                                                                                                                            <div>                                                                                                                                                                                                             <div>                                                                                                                                                                                                              <div>                                                                                                                                                                                                               <div>                                                                                                                                                                                                                <div>                                                                                                                                                                                                                 <div>                                                                                                                                                                                                                  <div>                                                                                                                                                                                                                   <div>                                                                                                                                                                                                                    <div>                                                                                                                                                                                                                     <div>                                                                                                                                                                                                                      <div>                                                                                                                                                                                                                       <div>                                                                                                                                                                                                                        <div>                                                                                                                                                                                                                         <div>                                                                                                                                                                                                                          <div>                                                                                                                                                                                                                           <div>                                                                                                                                                                                                                            <div>                                                                                                                                                                                                                             <div>                                                                                                                                                                                                                              <div>                                                                                                                                                                                                                               <div>                                                                                                                                                                                                                                <div>                                                                                                                                                                                                                                 <div>                                                                                                                                                                                                                                  <div>                                                                                                                                                                                                                                   <div>                                                                                                                                                                                                                                    <div>                                                                                                                                                                                                                                     <div>                                                                                                                                                                                                                                      <div>                                                                                                                                                                                                                                       <div>                                                                                                                                                                                                                                        <div>                                                                                                                                                                                                                                         <div>                                                                                                                                                                                                                                          <div>                                                                                                                                                                                                                                           <div>                                                                                                                                                                                                                                            <div>                                                                                                                                                                                                                                             <div>                                                                                                                                                                                                                                              <div>                                                                                                                                                                                                                                               <div>                                                                                                                                                                                                                                                <div>                                                                                                                                                                                                                                                 <div>                                                                                                                                                                                                                                                  <div>                                                                                                                                                                                                                                                   <div>                                                                                                                                                                                                                                                    <div>                                                                                                                                                                                                                                                     <div>                                                                                                                                                                                                                                                      <div>                                                                                                                                                                                                                                                       <div>                                                                                                                                                                                                                                                        <div>                                                                                                                                                                                                                                                         <div>                                                                                                                                                                                                                                                          <div>                                                                                                                                                                                                                                                           <div>                                                                                                                                                                                                                                                            <div>                                                                                                                                                                                                                                                             <div>                                                                                                                                                                                                                                                              <div>                                                                                                                                                                                                                                                               <div>                                                                                                                                                                                                                                                                <div>                                                                                                                                                                                                                                                                 <div>                                                                                                                                                                                                                                                                  <div>                                                                                                                                                                                                                                                                   <div>                                                                                                                                                                                                                                                                    <div>                                                                                                                                                                                                                                                                     <div>                                                                                                                                                                                                                                                                      <div>                                                                                                                                                                                                                                                                       <div>                                                                                                                                                                                                                                                                        <div>                                                                                                                                                                                                                                                                         <div>                                                                                                                                                                                                                                                                          <div>                                                                                                                                                                                                                                                                           <div>                                                                                                                                                                                                                                                                            <div>                                                                                                                                                                                                                                                                             <div>                                                                                                                                                                                                                                                                              <div>                                                                                                                                                                                                                                                                               <div>                                                                                                                                                                                                                                                                                <div>                                                                                                                                                                                                                                                                                 <div>                                                                                                                                                                                                                                                                                  <div>                                                                                                                                                                                                                                                                                   <div>                                                                                                                                                                                                                                                                                    <div>                                                                                                                                                                                                                                                                                     <div>                                                                                                                                                                                                                                                                                      <div>                                                                                                                                                                                                                                                                                       <div>                                                                                                                                                                                                                                                                                        <div>                                                                                                                                                                                                                                                                                         <div>                                                                                                                                                                                                                                                                                          <div>                                                                                                                                                                                                                                                                                           <div>                                                                                                                                                                                                                                                                                            <div>                                                                                                                                                                                                                                                                                             <div>                                                                                                                                                                                                                                                                                              <div>                                                                                                                                                                                                                                                               ";
            Assert.Throws<InvalidOperationException>(() => { result = sanitizer.Sanitize(input); });

        }

        /// <summary>
        /// HAP version < 1.7.1 contained a bug in how comments with a non standard end tag are handled, allowing certain maliscious snippets to get through.
        /// Credits go to David K. / @leeN
        /// </summary>
        [Fact]
        public void HtmlAgilityPackBadCommentHandling()
        {

            var sanitizer = new HtmlSanitizer();
            sanitizer.Tag("img").AllowAttributes("src");
            sanitizer.RemoveComments = false;

            // This comment tag will 'confuse' HAP versions before 1.7.1, allowing the maliscious onerror attribute contents to get through.
            var input = @"<!-- abc --!> <img src=x onerror=alert(1)>";
            var expected = @"<!-- abc --!> <img src=""x"">";
            var result = sanitizer.Sanitize(input);

            Assert.Equal(expected, result); 
        }
    }
}
